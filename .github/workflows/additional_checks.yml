name: Additional Checks

on:
  pull_request

jobs:
  Checks:
    runs-on: ubuntu-latest
    if: github.repository == 'ChaoticOnyx/OnyxBay' && github.base_ref == 'dev' && github.event.pull_request.draft == false
    env:
      BYOND_MAJOR: 513
      BYOND_MINOR: 1521
      DM_BUILDFILE: "baystation12.dme"
    steps:
      - name: Checkout
        uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f
        with:
          persist-credentials: true
          fetch-depth: 25
      - name: Install Byond
        run: |
          chmod +x ./install-byond.sh
          ./install-byond.sh
      - name: Steps Check
        run: |
          shopt -s globstar
          (! grep 'step_[xy]' maps/**/*.dmm)
          (! grep '\bnew/' **/*.dm)
      - name: Build
        run: |
          source $HOME/BYOND-${BYOND_MAJOR}.${BYOND_MINOR}/byond/bin/byondsetup
          bash dm.sh ${DM_BUILDFILE}
      - name: After Success
        if: ${{ success() }}
        env:
          WEBHOOK_URL: ${{secrets.$WEBHOOK_URL}}
        run: |
          chmod +x ./send-to-discord.sh
          ./send-to-discord.sh success $WEBHOOK_URL
      - name: After Failure
        if: ${{ failure() }}
        env:
          WEBHOOK_URL: ${{secrets.$WEBHOOK_URL}}
        run: |
          chmod +x ./send-to-discord.sh
          ./send-to-discord.sh failure $WEBHOOK_URL
