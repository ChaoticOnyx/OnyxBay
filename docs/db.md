# Базы данных

В билде используется несколько баз данных:

- [SurrealDB](https://surrealdb.com/docs/) - в ней хранятся данные относящиеся к геймплею и конкретному серверу, является предпочтительным способом хранения данных.
- **MySQL (Feedback)** - подключение к "feedback" базе данных, в которой хранятся баны и прочее не относящееся напрямую к геймплею.
- **MySQL (Dontaions)** - база данных связанная с донатами и в ней данные общие для всех серверов.

## Настройка SurrealDB

Изначально она уже настроена и ничего менять не надо, но для удобной отладки нужно запустить отдельный сервер с базой данных.

- Установка сервера - https://surrealdb.com/docs/surrealdb/installation/
- Установка UI - https://surrealdb.com/surrealist

Запуск из папки с билдом:

```sh
$ surreal start file:data/database --bind 127.0.0.1:8000
```

В секции `db` конфигурации билда нужно прописать новый адрес, логин и пароль:

```toml
[db]
address = "ws://127.0.0.1:8000"
namespace = "ss13"
login = "root"
password = "root"
```

Теперь можно запускать и билд и одновременно работать с базой данных через **Surrealist**.

## Настройка MySQL

В папке `sql/` содержится Docker образ и схемы двух последних баз данных: новая - `feedback`, донаты - `donations`. В продакшене каждый сервер имеет свою `feedback` базу данных, но для простоты и разработки будет достаточно одной.

### Первоначальная настройка

- Необходимо установить **Docker Hub**: https://www.docker.com/get-started/
- Открыть в терминале папку с билдом:

```sh
$ cd OnyxBay/
```

- Собрать образ:

```sh
$ ./sql/Build.ps1
```

_Если у вас есть только bash/sh - выполняйте аналогичный файл но с расширением `.sh`_

#### Запуск

```sh
$ ./sql/Run.ps1
```

В консоли могут появится ошибки - не страшно, это значит что контейнер запускается в первый раз.

#### Остановка

Остановить контейнер с MySQL вы можете через интерфейс Docker Desktop или с помощью команды:

```sh
$ docker stop onyxdb
```

### Конфигурация

Конфигурация базы данных расположена в секции `db` (пример: `config/default/db.toml`). Из этого файла билд узнаёт куда надо подключаться и с каким логином/паролем.

По-умолчанию конфигурация уже сделана под Docker образ и её не нужно трогать.

### Возможные проблемы

> Как сделать себя администратором?

Необходимо добавить свой `ckey` и права в таблицу `erro_admin`, пример:

| id  | ckey     | rank | flags |
| --- | -------- | ---- | ----- |
| ... | igorsaux | Host | 12795 |

`ckey` - ваш `ckey`.

`rank` - ранг администратора, отображается в `adminwho`. `Host` - наивысший ранг.

`flags` - ваши права. Число `12795` даёт большинство необходимых прав. Остальные по необходимости можно будет добавить в игре.
